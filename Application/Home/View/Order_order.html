<section class="content-header">
    <h1>
        订单管理
        <small></small>
    </h1>
</section>
<style>
    /*弹框样式*/
    .hide_box{z-index:999;filter:alpha(opacity=50);background:#666;opacity: 0.5;-moz-opacity: 0.5;left:0;top:0;height:99%;width:100%;position:fixed;display:none;}
    .shang_box{background-color:#fff;border-radius:5px;position:fixed;z-index:1000;left:50%;top:50%;margin-left:-450px;margin-top:-280px;display:none;}
    .shang_box img{border:none;border-width:0;}
    .shang_close{float:right;display:inline-block;}
    .shang_top{ width:980px; background:#16aad8; height:40px; border-top-left-radius:5px; border-top-right-radius:5px; line-height:40px; padding-right:20px; }
</style>
<!--弹框-->
<div class="hide_box"></div>
<div class="shang_box">
    <div class="shang_top">
        <a class="shang_close" href="javascript:void(0)" onClick="dashangToggle()" title="关闭"  style="color:#FFFFFF; text-decoration:none;">关闭</a>
    </div>
    <br/>
    <div style="max-height: 550px; overflow:auto;">
        <table class="table table-bordered table-hover" id="tc">
            <tbody></tbody>
        </table>
    </div>
</div>
<!--弹框-->
<!-- Main content -->
<section class="content">
    <div class="row">
        <div class="col-md-12">
            <!-- general form elements -->
            <div class="box box-default">
                <div class="box-header with-border">
                    <h3 class="box-title">订单搜索</h3>
                </div>
                <!-- form start -->
                <form class="form-horizontal" action="{:U('Home/Order/search')}" method="post">
                    <div class="box-body">
                        <div class="form-group">
                            <!--<label class="col-sm-1 control-label">商品</label>

                            <div class="col-sm-3">
                                <select name="product_id" class="form-control">
                                    <option value="-10">不选择商品</option>
                                    <volist name="productList" id="list">
                                        <option value="{$list.id}">{$list.name}</option>
                                    </volist>
                                </select>
                            </div>-->
                            
                            <label class="col-sm-1 control-label">订单编号</label>

                            <div class="col-sm-3">
                                <input class="form-control" name="orderid" placeholder="" value="{$orderPost.orderid}"
                                       type="text">
                            </div>

                            <label class="col-sm-1 control-label">用户名</label>

                            <div class="col-sm-3">
                                <input class="form-control" name="student_xsxm" placeholder="" value="{$orderPost.student_xsxm}"
                                       type="text">
                            </div>

                            <label class="col-sm-1 control-label">备注</label>

                            <div class="col-sm-3">
                                <select name="remark" class="form-control">
                                    <option value="-10">不选择备注</option>
                                    <option value="1">不空</option>
                                    <!--<option value="0">空</option>-->
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-1 control-label">支付方式</label>

                            <div class="col-sm-3">
                                <select name="payment" class="form-control">
                                    <option value="-10">不选择支付方式</option>
                                    <option value="0">账户支付</option>
                                    <option value="1">微信支付</option>
                                    <option value="2">支付宝支付</option>
                                    <option value="3">货到付款</option>
                                </select>
                            </div>

                            <label class="col-sm-1 control-label">支付状态</label>

                            <div class="col-sm-3">
                                <select name="pay_status" class="form-control">
                                    <option value="-10">不选择支付状态</option>
                                    <option value="0">未支付</option>
                                    <option value="1">已支付</option>
                                    <option value="2">已完成</option>
                                </select>
                            </div>

                            

                            <!--<label class="col-sm-1 control-label">订单状态</label>

                            <div class="col-sm-3">
                                <select name="status" class="form-control">
                                    <option value="-10">不选择订单状态</option>
                                    <option value="0">未处理</option>
                                    <option value="1">已发货</option>
                                    <option value="2">已完成</option>
                                    <option value="-1">已取消</option>
                                    <option value="-2">退货中</option>
                                    <option value="-3">退货完成</option>
                                    <option value="-4">申请退货</option>
                                </select>
                            </div>-->
                        </div>

                        <div class="form-group">
                            <label class="col-sm-1 control-label">时间范围</label>

                            <div class="col-sm-7">
                                <div class="input-group">
                                    <div class="input-group-addon">
                                        <i class="fa fa-clock-o"></i>
                                    </div>
                                    <input type="text" class="form-control pull-right" name="timeRange"
                                           id="reservationtime" value="{$orderPost.timeRange}">
                                </div>
                            </div>
                            <!-- /.input group -->
                        </div>
                    </div>
                    <!-- /.box-body -->

                    <div class="box-footer">
                        <div class="col-sm-2">
                            <button type="submit" class="btn btn-block btn-danger">开始搜索</button>
                        </div>
                    </div>
                </form>
            </div>
            <!-- /.box -->
        </div>
        <!--/.col (right) -->
    </div>

    <div class="row">
        <!-- /.col -->
        <div class="col-md-12">
            <div class="box box-danger">
                <div class="box-header with-border">
                    <h3 class="box-title">订单管理</h3>
                    <!-- /.box-tools -->
                </div>
                <!-- /.box-header -->
                <div class="box-body no-padding">
                    <div class="mailbox-controls">
                        <div class="btn-group">
                            <a href="{:U('Home/Order/export',array('status'=>I('get.status') , 'pay_status'=>I('get.pay_status') ,'day'=>I('get.day')))}"
                               target="_blank" class="btn btn-danger">
                                导出全部订单
                            </a>
                        </div>
                        <!-- /.btn-group -->
                    </div>

                    <div class="mailbox-controls">
                        <!--<div class="btn-group">
                            <button type="button" class="btn btn-danger "
                                    onclick="batchUrl('{:U(\'Home/Order/wxPrint\')}')">打印
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-danger "
                                    onclick="batchUrl('{:U(\'Home/Order/update\',array(\'status\'=>1))}')">发货
                            </button>
                        </div>-->
                        <!--<div class="btn-group">-->
                            <!--<button type="button" class="btn btn-danger "-->
                                    <!--onclick="batchUrl('{:U(\'Home/Order/update\',array(\'pay_status\'=>1))}')">-->
                                <!--已支付-->
                            <!--</button>-->
                        <!--</div>-->
                        <!--<div class="btn-group">
                            <button type="button" class="btn btn-danger "
                                    onclick="batchUrl('{:U(\'Home/Order/update\',array(\'status\'=>-1))}')">取消
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-danger "
                                    onclick="batchUrl('{:U(\'Home/Order/update\',array(\'status\'=>2))}')">已完成
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-danger "
                                    onclick="batchUrl('{:U(\'Home/Order/update\',array(\'status\'=>-2))}')">退货中
                            </button>
                        </div>
                        <div class="btn-group">
                            <button type="button" class="btn btn-danger "
                                    onclick="batchUrl('{:U(\'Home/Order/update\',array(\'status\'=>-3))}')">已退货
                            </button>
                        </div>-->
                        <div class="btn-group">
                            <button type="button" class="btn btn-danger "
                                    onclick="batchUrl('{:U(\'Home/Order/export\',array(\'status\'=>I(\'get.status\') , \'pay_status\'=>I(\'get.pay_status\') ,\'day\'=>I(\'get.day\')))}',false)">
                                导出订单
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive" style="overflow-x: visible;">
                        <table class="table table-bordered table-hover">
                            <tbody>
                            <tr>
                                <th class="hidden-xs">
                                    <label><input onchange="checkAll()" type="checkbox" value=""></label>
                                </th>
                                <th>店铺名称</th>
                                <th>订单编号</th>
                                <th>菜单</th>
                                <!--<th>联系人</th>
                                <th>地址</th>-->
                                <th>备注</th>
                                <th>价格</th>
                                <!--<th>优惠</th>
                                <th>支付方式</th>-->
                                <th>支付状态</th>
                                <!--<th>订单状态</th>
                                <th>配送时间</th>
                                <th>订单详情</th>-->
                                <th>用户名</th>
                                <th>班级</th>
                                
                                <th>时间</th>
                                <th>订单详情</th>
                            </tr>
                            <volist name="orderList" id="order">
                                <tr>
                                    <td class="hidden-xs">
                                        <label><input name="checkbox" class="check" type="checkbox" value="{$order.id}"></label>
                                    </td>
                                    <td>
                                        {$order.shop.name}
                                    </td>
                                    <td>
                                        {$order.orderid}
                                    </td>
                                    <td>
                                        {$order.menu.name}
                                    </td>
                                    <!--<td>
                                        <div>联系人:<span class="badge">{$order.contact.name}</span></div>
                                        <div>手机号:<span class="badge">{$order.contact.phone}</span></div>

                                    </td>
                                    <td style="max-width: 200px;overflow: hidden;">
                                        <div>{$order.contact.province}</div>
                                        <div>{$order.contact.city}</div>
                                        <div>{$order.contact.address}</div>
                                    </td>-->
                                    <td class="hidden-xs">
                                        {$order.remark}
                                    </td>
                                    
                                    <td class="hidden-xs">
                                        <span style="background-color: #dd4b39;" class="badge">{$order.totalprice}元</span>
                                    </td>
                                    <!--<td class="hidden-xs">
                                        {$order.discount}
                                    </td>
                                    <td class="hidden-xs">
                                        <if condition="$order.payment eq 0">账户支付
                                            <elseif condition="$order.payment eq 1"/>
                                            微信支付
                                            <elseif condition="$order.payment eq 2"/>
                                            支付宝支付
                                            <else/>
                                            货到付款
                                        </if>
                                    </td>-->
                                    <td class="hidden-xs">
                                        <if condition="$order.pay_status eq 1">
                                            已支付
                                        <elseif condition="$order.pay_status eq 0"/>
                                            <font color="red">未支付</font>
                                        <else/>
                                            <font color="blue">已完成</font>
                                        </if>
                                    </td>
                                    <!--<td class="hidden-xs">
                                        <if condition="$order.status eq -1">已取消
                                            <elseif condition="$order.status eq 0"/>
                                            <font color="red">未处理</font>
                                            <elseif condition="$order.status eq 1"/>
                                            <font color="blue">已发货</font>
                                            <elseif condition="$order.status eq -2"/>
                                            <font color="blue">已退货</font>
                                            <elseif condition="$order.status eq -3"/>
                                            退货完成
                                            <elseif condition="$order.status eq 2"/>
                                            已完成
                                            <elseif condition="$order.status eq -4"/>
                                            申请退货
                                        </if>
                                    </td>
                                    <td class="hidden-xs">
                                        {$order.delivery_time}
                                    </td>
                                    <td class="hidden-xs">
                                        <php>
                                            $data = $order[detail];
                                            for($i=0;$i < count($data);$i++){
                                            echo '
                                            <div>'.$data[$i][name].$data[$i][attr].'<span class="badge">'.$data[$i][price].'元*'.$data[$i][num].'</span>
                                            </div>
                                            ';
                                            }
                                        </php>

                                    </td>-->
                                    <td class="hidden-xs">
                                        {$order.student.xsxm}
                                    </td>
                                    <td class="hidden-xs">
                                        {$order.class.bjmc}
                                    </td>
                                    
                                    <td class="hidden-xs">
                                        {$order.time}
                                    </td>
                                    <td class="hidden-xs">
                                        <a href="javascript:void(0)" onClick="dashangToggle({$order.id})" class="dashang" title="详情">详情</a>
                                    </td>
                                </tr>
                            </volist>
                            </tbody>
                        </table>
                        <div class="box-footer no-padding">
                            <div class="mailbox-controls">
                                <!--<div class="btn-group">
                                    <button type="button" class="btn btn-danger "
                                            onclick="batchUrl('{:U(\'Home/Order/wxPrint\')}')">打印
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger "
                                            onclick="batchUrl('{:U(\'Home/Order/update\',array(\'status\'=>1))}')">发货
                                    </button>
                                </div>-->
                                <!--<div class="btn-group">-->
                                    <!--<button type="button" class="btn btn-danger "-->
                                            <!--onclick="batchUrl('{:U(\'Home/Order/update\',array(\'pay_status\'=>1))}')">-->
                                        <!--已支付-->
                                    <!--</button>-->
                                <!--</div>-->
                                <!--<div class="btn-group">
                                    <button type="button" class="btn btn-danger "
                                            onclick="batchUrl('{:U(\'Home/Order/update\',array(\'status\'=>-1))}')">取消
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger "
                                            onclick="batchUrl('{:U(\'Home/Order/update\',array(\'status\'=>2))}')">已完成
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger "
                                            onclick="batchUrl('{:U(\'Home/Order/update\',array(\'status\'=>-2))}')">退货中
                                    </button>
                                </div>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger "
                                            onclick="batchUrl('{:U(\'Home/Order/update\',array(\'status\'=>-3))}')">已退货
                                    </button>
                                </div>-->
                                <div class="btn-group">
                                    <button type="button" class="btn btn-danger "
                                            onclick="batchUrl('{:U(\'Home/Order/export\',array(\'status\'=>I(\'get.status\') , \'pay_status\'=>I(\'get.pay_status\') ,\'day\'=>I(\'get.day\')))}',false)">
                                        导出订单
                                    </button>
                                </div>
                                <!-- /.btn-group -->
                                <div class="pull-right">
                                    {$page}
                                    <!-- /.btn-group -->
                                </div>
                                <!-- /.pull-right -->
                            </div>
                        </div>
                    </div>
                    <!-- /.mail-box-messages -->
                </div>
            </div>
            <!-- /. box -->
        </div>
        <!-- /.col -->
    </div>
</section>
<script type="text/javascript">
    $(function () {
        $('#reservationtime').daterangepicker({
            timePicker: true,
            timePickerIncrement: 30,
            format: 'YYYY-MM-DD h:mm:ss',
            separator: ' --- ',
        });
        //下拉菜单选中状态
        if ('{$orderPost}') {
            $('select[name="remark"]').val('{$orderPost.remark}');
            $('select[name="payment"]').val('{$orderPost.payment}');
            $('select[name="pay_status"]').val('{$orderPost.pay_status}');
            $('select[name="status"]').val('{$orderPost.status}');
            $('select[name="product_id"]').val('{$orderPost.product_id}');
        }
    });
    /*弹框JS内容*/
    function dashangToggle(order_id){
        $.post('{:U(\'Home/Order/productlist\')}',{order_id},function(data){
            var html = '<tr><th>商品时间</th><th>商品名称</th><th>价格</th><th>请假状态</th><th>退餐状态</th></tr>';
            var leave_status = '';
            var retreat_status = '';
            obj= $.parseJSON(data)
            //多维数组循环
            $.each(obj,function(index,content){
                if(content['leave_status'] == -1){
                    leave_status = '申请中';
                }else if(content['leave_status'] == 0){
                    leave_status = '正常';
                }else if(content['leave_status'] == 1){
                    leave_status = '已请假';
                }else{     
                }
                if(content['retreat_status'] == -1){
                    retreat_status = '申请中';
                }else if(content['retreat_status'] == 0){
                    retreat_status = '正常';
                }else if(content['retreat_status'] == 1){
                    retreat_status = '已退餐';
                }else{     
                }
                //表格内容
                html +='<tr><td>'+ content['product']['order_date'] + '</td><td>' + content['name'] + '</td><td>' + content['price'] + '元</td><td>' + leave_status + '</td><td>' + retreat_status + '</td></tr>';
            });
            $('#tc tbody').html(html);
            
            $(".hide_box").fadeToggle();
            $(".shang_box").fadeToggle();
        })
        
    }
</script>